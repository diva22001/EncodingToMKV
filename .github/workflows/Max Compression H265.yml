name: Encode Video MKV (Max Compression H265)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct URL video (mp4/mkv/avi)"
        required: true
        type: string
      output_name:
        description: "Nama file output (tanpa .mkv)"
        required: false
        default: "encoded_video_hevc"
        type: string

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg jq curl rclone

      - name: Download Video
        run: |
          echo "Download video..."
          curl -L "${{ inputs.video_url }}" -o input_video

      - name: Encode Video (H265 + 1080p + Ultra Compression)
        run: |
          # Optimasi Kompresi Maksimal dengan H.265:
          # - c:v libx265: Menggunakan codec HEVC untuk kompresi tinggi.
          # - b:v 1100k: Target bitrate video rendah agar ukuran file kecil.
          # - preset faster: H.265 lebih berat dari H.264, preset ini cukup optimal di GitHub Actions.
          # - x265-params: Mengoptimalkan pengaturan untuk konten film (aq-mode, dll).
          # - pix_fmt yuv420p10le: Menggunakan 10-bit agar tidak pecah (banding) di bitrate rendah.
          
          ffmpeg -y -hide_banner -nostats \
            -threads 0 \
            -i input_video \
            -vf "scale=1920:1080" \
            -c:v libx265 \
            -preset faster \
            -b:v 1100k \
            -maxrate 2000k \
            -bufsize 4000k \
            -pix_fmt yuv420p10le \
            -x265-params "aq-mode=3:deblock=-1,-1:strong-intra-smoothing=0" \
            -c:a aac \
            -b:a 128k \
            -ar 48000 \
            "${{ inputs.output_name }}.mkv"

      - name: Setup Rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

      - name: Upload to Google Drive
        run: |
          # Mengunggah file ke Google Drive menggunakan rclone
          # Pastikan nama remote di rclone.conf Anda sesuai (contoh: 'gd-drive')
          # Folder tujuan bisa disesuaikan setelah tanda titik dua (:)
          rclone copy "${{ inputs.output_name }}.mkv" "gd-drive:/" --progress
