name: Encode Video (AV1 / HEVC)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct URL video (mp4/mkv/avi)"
        required: true
        type: string
      output_name:
        description: "Nama file output (tanpa .mkv)"
        required: false
        default: "encoded_video"
        type: string
      codec:
        description: "av1 atau hevc"
        required: false
        default: "av1"
        type: choice
        options:
          - av1
          - hevc

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Install Base Tools
        run: |
          sudo apt update
          sudo apt install -y curl jq

      # ===============================
      # Install FFmpeg Static
      # ===============================
      - name: Install FFmpeg Static
        run: |
          curl -L https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz -o ffmpeg.tar.xz
          tar -xf ffmpeg.tar.xz
          sudo mv ffmpeg-*-static/ffmpeg /usr/local/bin/
          sudo chmod +x /usr/local/bin/ffmpeg
          ffmpeg -version

      # ===============================
      # Install Rclone
      # ===============================
      - name: Install Rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      # ===============================
      # Setup & VALIDASI RCLONE (SEBELUM DOWNLOAD)
      # ===============================
      - name: Setup & Validate Rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

          echo "== Checking rclone remotes =="
          REMOTES=$(rclone listremotes)

          if [ -z "$REMOTES" ]; then
            echo "ERROR: Tidak ada remote rclone terdeteksi"
            exit 1
          fi

          echo "Remote tersedia:"
          echo "$REMOTES"

          if ! echo "$REMOTES" | grep -q "^lasenameygd:"; then
            echo "ERROR: Remote 'lasenameygd' tidak ditemukan"
            exit 1
          fi

      # ===============================
      # Download Video (BARU JALAN JIKA RCLONE VALID)
      # ===============================
      - name: Download Video
        run: |
          curl -L "${{ inputs.video_url }}" -o input_video.mp4

      # ===============================
      # Encode
      # ===============================
      - name: Encode Video
        run: |
          if [ "${{ inputs.codec }}" = "av1" ]; then
            ffmpeg -y \
              -i input_video.mp4 \
              -vf "scale=1920:1080" \
              -c:v libaom-av1 \
              -preset 8 \
              -crf 32 \
              -pix_fmt yuv420p10le \
              -c:a aac \
              -b:a 128k \
              "${{ inputs.output_name }}.mkv"
          else
            ffmpeg -y \
              -i input_video.mp4 \
              -vf "scale=1920:1080" \
              -c:v libx265 \
              -preset slow \
              -crf 23 \
              -pix_fmt yuv420p \
              -c:a aac \
              -b:a 128k \
              "${{ inputs.output_name }}.mkv"
          fi

      # ===============================
      # Upload
      # ===============================
      - name: Upload to Google Drive
        run: |
          rclone copy "${{ inputs.output_name }}.mkv" "lasenameygd:/" --progress
