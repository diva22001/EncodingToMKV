name: Encode Video MKV (Max Compression AV1)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct URL video (mp4/mkv/avi/m3u8)"
        required: true
        type: string
      output_name:
        description: "Nama file output (tanpa .mkv)"
        required: true
        type: string

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg jq curl

      - name: Install Rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Setup & Validate Rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf
          rclone listremotes

      - name: Prepare Input (Support m3u8)
        run: |
          URL="${{ inputs.video_url }}"
          if echo "$URL" | grep -qiE "\.m3u8($|\?)"; then
            echo "INPUT_SOURCE=$URL" >> $GITHUB_ENV
          else
            curl -L "$URL" -o input_video
            echo "INPUT_SOURCE=input_video" >> $GITHUB_ENV
          fi

      - name: Encode Video (AV1 1080p Ultra Compression)
        run: |
          ffmpeg -y -loglevel error \
            -i "$INPUT_SOURCE" \
            -vf "scale=1920:1080" \
            -c:v libsvtav1 \
            -preset 12 \
            -b:v 1100k \
            -pix_fmt yuv420p10le \
            -c:a aac \
            -b:a 128k \
            "${{ inputs.output_name }}.mkv"

      - name: Upload with fallback & Telegram notify
        env:
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          set -euo pipefail
          FILE="${{ inputs.output_name }}.mkv"

          notify () {
            curl -fsS -X POST \
              "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
              -d "chat_id=${TG_CHAT_ID}" \
              --data-urlencode "text=$1"
          }

          upload_drive () {
            rclone copy "$FILE" "$1:/" --progress
          }

          if upload_drive "lasenameygd"; then
            notify "$(printf "✅ Upload berhasil\nNama file: %s\nDrive: lasenameygd" "$FILE")"

          elif upload_drive "divagd"; then
            notify "$(printf "✅ Upload berhasil\nNama file: %s\nDrive: divagd" "$FILE")"

          elif upload_drive "kidulroro"; then
            notify "$(printf "✅ Upload berhasil\nNama file: %s\nDrive: kidulroro" "$FILE")"

          else
            RESPONSE=$(curl -fsS -# -o - -T "$FILE" "https://w.buzzheavier.com/$FILE")
            ID=$(echo "$RESPONSE" | jq -r '.data.id')

            if [ -z "$ID" ] || [ "$ID" = "null" ]; then
              notify "$(printf "❌ Upload gagal total\nNama file: %s" "$FILE")"
              exit 1
            fi

            URL="https://buzzheavier.com/$ID"

            notify "$(printf "⚠️ Semua Drive gagal\nNama file: %s\nLink: %s" "$FILE" "$URL")"
          fi
