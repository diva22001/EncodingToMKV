name: Encode Video MKV (Max Compression AV1)

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: "Direct URL video (mp4/mkv/avi)"
        required: true
        type: string
      output_name:
        description: "Nama file output (tanpa .mkv)"
        required: false
        default: ""
        type: string

jobs:
  encode:
    runs-on: ubuntu-latest

    steps:
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y ffmpeg jq curl

      # ===============================
      # Install Rclone
      # ===============================
      - name: Install Rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      # ===============================
      # Setup & VALIDASI RCLONE (SEBELUM DOWNLOAD)
      # ===============================
      - name: Setup & Validate Rclone
        run: |
          mkdir -p ~/.config/rclone
          echo "${{ secrets.RCLONE_CONFIG_BASE64 }}" | base64 -d > ~/.config/rclone/rclone.conf

          echo "== Checking rclone remotes =="
          REMOTES=$(rclone listremotes)

          if [ -z "$REMOTES" ]; then
            echo "ERROR: Tidak ada remote rclone terdeteksi"
            exit 1
          fi

          echo "Remote tersedia:"
          echo "$REMOTES"

          if ! echo "$REMOTES" | grep -q "^lasenameygd:"; then
            echo "ERROR: Remote 'lasenameygd' tidak ditemukan"
            exit 1
          fi

      # ===============================
      # Download Video (BARU JALAN JIKA RCLONE VALID)
      # ===============================
      
      - name: Prepare Input (Support m3u8)
        run: |
          URL="${{ inputs.video_url }}"

          if echo "$URL" | grep -qiE "\.m3u8($|\?)"; then
            echo "Detected m3u8 stream"
            echo "INPUT_SOURCE=$URL" >> $GITHUB_ENV
            echo "INPUT_TYPE=m3u8" >> $GITHUB_ENV
          else
            echo "Detected direct video file"
            curl -L "$URL" -o input_video
            echo "INPUT_SOURCE=input_video" >> $GITHUB_ENV
            echo "INPUT_TYPE=file" >> $GITHUB_ENV
          fi

      - name: Encode Video (AV1 + 1080p + Ultra Compression)
        run: |
          ffmpeg -y -hide_banner -nostats \
            -threads 0 \
            -fflags +genpts \
            -loglevel error \
            -i "$INPUT_SOURCE" \
            -vf "scale=1920:1080" \
            -c:v libsvtav1 \
            -preset 12 \
            -b:v 1100k \
            -maxrate 2000k \
            -bufsize 4000k \
            -pix_fmt yuv420p10le \
            -svtav1-params tune=0:enable-overlays=1 \
            -c:a aac \
            -b:a 128k \
            -ar 48000 \
            "${{ inputs.output_name }}.mkv"


      # ===============================
      # Upload
      # ===============================
      - name: Upload to Google Drive
        run: |
          rclone copy "${{ inputs.output_name }}.mkv" "lasenameygd:/" --progress
